

## 接口幂等性

1. ### 我们为什么要设计接口幂等性？

2. ### 什么是接口幂等性？

3. ### 如何设计接口幂等性？

### 我们为什么要设计接口幂等性？应用场景是什么？

1、前端重复提交

用户注册，用户创建商品等操作，前端都会提交数据给后台服务，后台需要根据用户提交的数据在DB中创建记录。如果用户不小心多点了几次，后端收到了好几次提交，这时就会在数据库中重复创建了多条记录。这就是接口没有幂等性带来的bug。如果涉及金钱等敏感、安全的业务产生的后果更加严重。

2、接口超时重试

如果服务是给第三方调用的接口，有可能会因为网络的原因调用失败，这时候，业务方在请求接口时候一般会有重试机制，如果第一次在调用一半的时候，放生了网络异常。这时候在调用就会因为脏数据存在，出现调用异常。

3、消息重复消费

如果我们技术架构中有消息队列，且是手动ack确认消息被正常消费时。如果消费者突然断开连接，那么执行一般的消息会重新放入队列。

当消息，被其他消费者重新消费的时候，如果没有幂等性，就会导致消息重复消费时结果异常，如数据库重复数据，数据库数据冲突，资源重复等。影响业务和接口的稳定性

### 那什么是接口幂等性？

幂等性：多次调用方法或者接口不会改变业务状态，可以保证重复调用的结果和单次调用的结果一致。

### 如何设计接口幂等性？

1、token机制实现

通过token机制实现接口的幂等性，是比较通用性的实现方法：

​	1、客户端会先发送一个请求去获取token，服务端会生成一个全局唯一的ID作为token保存在redis（不建议存储在DB中I/O操作时间比较长)中，同时把这个ID返回给客户端

​	2、客户端获取token后，携带token进行业务请求。

​	3、服务端会校验这个token，如果校验成功，则执行业务，并删除redis中的token

​	4、如果校验失败，说明redis中没有对应token，则表示重复操作，直接返回指定的结果给客户端

注意：

​	1、对redis中是否存在token以及删除的代码逻辑，建议用Lua脚本时间，保证原子性

​	2、全局唯一ID可以使用百度的uid-generator。

2、基于mysql实现

​	这种实现方法是利用mysql唯一索引的特性

​	1、建立一张去重表，其中某个字段需要建立唯一索引

​	2、客户端去请求服务端，服务端会将这次请求的一些信息插入这张去重表中

​	3、因为表中某个字段带有唯一索引，如果插入成功，证明表中没有这次请求的信息，则执行后续的业务逻辑

​	4、如果插入失败，则代表已经执行过当前的请求，直接返回

3、基于redis实现

上面我们又说使用redis的一种方法，但是第一种方法只是利用了redis 是内存存储工具，数据I/O速度较快。

本方法是基于redis的数据类型，基于自身的功能实现的，那就是SETNX来实现，这个方法相当于redis自身实现了锁机制。

SETNX key value：将key的值作为value，并当且仅当 key 不存在。若给定的 key 已经存在，则 SETNX 不作任何动作。

该命令在设置成功的时候返回 1，设置失败时返回 0。

具体实现：

​	1、客户端先请求服务端，会拿到一个能代表这次请求业务的唯一字段

​	2、将该字段以 SETNX 的方式存储到 redis 中，并根据业务设置相应的超时时间

​	3、如果设置成功，证明是第一次请求，则执行后续的业务逻辑

​	4、如果设置失败，则代表已经执行过当前的请求，直接返回

## 总结

1、在设计接口时，我们要考虑安全性到问题，除了稳定性、权限验证等等外，也要考虑幂等性，尤其是涉及到金额转账、支付等业务场景（主要是因为涉及到 money），就需要更加小心！


